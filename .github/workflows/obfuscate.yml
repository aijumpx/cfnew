name: Generate and Obfuscate Worker Script

on:
  workflow_dispatch:  # 允许手动在 Actions 页面点击运行
  push:
    branches:
      - '**' 
    paths:
      - 'snippets' # 只有当 snippets.js 发生变化时才触发，防止死循环

jobs:
  build-and-obfuscate:
    runs-on: ubuntu-latest
    permissions:      # 必须添加权限，否则机器人无法提交代码回仓库
      contents: write 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Obfuscator
        run: npm install javascript-obfuscator

      - name: Obfuscate Script
        run: |
          # 创建混淆脚本
          cat > obfuscate_task.js << 'EOF'
          const JavaScriptObfuscator = require('javascript-obfuscator');
          const fs = require('fs');
          const path = require('path');
          
          // --- 配置区域 ---
          const sourceFileName = 'snippets';  // 你的源文件名
          const outputFileName = 'worker.js';    // 混淆后的文件名
          // ----------------
          
          const sourceFilePath = path.join(process.cwd(), sourceFileName);

          if (!fs.existsSync(sourceFilePath)) {
            console.error(`错误：找不到源文件 ${sourceFileName}`);
            process.exit(1);
          }

          const originalCode = fs.readFileSync(sourceFilePath, 'utf8');

          const obfuscationOptions = {
              // --- 基础压缩 ---
              compact: true,
              simplify: true,
              target: 'browser-no-eval',
              
              // --- 混淆强度 (乱序逻辑) ---
              controlFlowFlattening: true,
              controlFlowFlatteningThreshold: 0.8, // 提高到 80% 逻辑混淆
              
              // --- 关键：自动加密你的配置 (UUID/域名) ---
              stringArray: true,              // 开启字符串提取
              stringArrayThreshold: 1,        // 100% 的字符串都会被处理
              stringArrayEncoding: ['rc4'],   // 使用 RC4 加密 (比 Base64 更难破解，全自动)
              splitStrings: true,             // 切割长字符串，增加阅读难度
              
              // --- 防止 Cloudflare 1101 报错的保护配置 ---
              renameGlobals: false,           // 保护 Worker 全局变量
              renameProperties: false,        // 保护 request.cf 等属性
              ignoreImports: true,            // 保护 import { connect }
              
              // 保护关键函数名不被修改
              reservedNames: [
                  'fetch', 'default', 'connect', 'env', 'ctx', 'request',
                  'WebSocketPair', 'Response', 'ReadableStream', 'WritableStream'
              ],
              
              // --- 调试保护 ---
              disableConsoleOutput: false,    // 必须为 false，防止报错
              selfDefending: false,           // 必须为 false
              debugProtection: false
          };
          const obfuscatedCode = JavaScriptObfuscator.obfuscate(originalCode, obfuscationOptions).getObfuscatedCode();
          
          fs.writeFileSync(path.join(process.cwd(), outputFileName), obfuscatedCode, 'utf8');
          console.log(`混淆完成：${outputFileName}`);
          EOF
          
          # 执行混淆
          node obfuscate_task.js

      - name: Commit and push
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # 强制添加生成的 worker.js
          git add worker.js
          
          # 检查是否有变化，有则提交
          if git diff --staged --quiet; then
            echo "没有检测到文件变化，跳过提交。"
          else
            git commit -m "Auto deploy: 混淆代码更新 [skip ci]" 
            # [skip ci] 很重要，防止提交后再次触发工作流导致死循环
            git push
          fi
