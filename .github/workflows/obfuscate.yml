name: Generate and Obfuscate Worker Script

on:
  workflow_dispatch:  # 允许手动在 Actions 页面点击运行
  push:
    branches:
      - '**' 
    paths:
      - 'snippets.js' # 只有当 snippets.js 发生变化时才触发，防止死循环

jobs:
  build-and-obfuscate:
    runs-on: ubuntu-latest
    permissions:      # 必须添加权限，否则机器人无法提交代码回仓库
      contents: write 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Obfuscator
        run: npm install javascript-obfuscator

      - name: Obfuscate Script
        run: |
          # 创建混淆脚本
          cat > obfuscate_task.js << 'EOF'
          const JavaScriptObfuscator = require('javascript-obfuscator');
          const fs = require('fs');
          const path = require('path');
          
          // --- 配置区域 ---
          const sourceFileName = 'snippets.js';  // 你的源文件名
          const outputFileName = 'worker.js';    // 混淆后的文件名
          // ----------------
          
          const sourceFilePath = path.join(process.cwd(), sourceFileName);

          if (!fs.existsSync(sourceFilePath)) {
            console.error(`错误：找不到源文件 ${sourceFileName}`);
            process.exit(1);
          }

          const originalCode = fs.readFileSync(sourceFilePath, 'utf8');

          const obfuscationOptions = {
              compact: true,
              controlFlowFlattening: true,       // 开启控制流扁平化，增加难度
              controlFlowFlatteningThreshold: 1, // 100% 概率
              stringArray: true,
              stringArrayEncoding: ['base64'],   // 字符串加密
              stringArrayThreshold: 1,
              target: 'browser-no-eval',         // 针对 Cloudflare/Browser 环境优化
              disableConsoleOutput: true,
              selfDefending: true                // 开启自我防御
          };

          const obfuscatedCode = JavaScriptObfuscator.obfuscate(originalCode, obfuscationOptions).getObfuscatedCode();
          
          fs.writeFileSync(path.join(process.cwd(), outputFileName), obfuscatedCode, 'utf8');
          console.log(`混淆完成：${outputFileName}`);
          EOF
          
          # 执行混淆
          node obfuscate_task.js

      - name: Commit and push
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # 强制添加生成的 worker.js
          git add worker.js
          
          # 检查是否有变化，有则提交
          if git diff --staged --quiet; then
            echo "没有检测到文件变化，跳过提交。"
          else
            git commit -m "Auto deploy: 混淆代码更新 [skip ci]" 
            # [skip ci] 很重要，防止提交后再次触发工作流导致死循环
            git push
          fi
